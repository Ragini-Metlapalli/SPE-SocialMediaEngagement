apiVersion: apps/v1
kind: Deployment
metadata:
  name: social-media-backend
  labels:
    app: backend
spec:
  progressDeadlineSeconds: 7200
  replicas: 2
  selector:
    matchLabels:
      app: backend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app: backend

    spec:
      # ----------------------------
      # INIT CONTAINER
      # ----------------------------
      # initContainers:
      #   - name: model-preloader
      #     image: raginimetlapalli/model-downloader-final:latest
      #     command: ["/bin/sh", "-c"]
      #     args:
      #       - |
      #         echo "Copying HF models from image â†’ PVC..."
      #         mkdir -p /models-cache
      #         cp -r /models/* /models-cache/ || true

      #         echo "Copying Detoxify checkpoint..."
      #         mkdir -p /models-cache/checkpoints
      #         cp -r /root/.cache/torch/hub/checkpoints/* /models-cache/checkpoints/ || true

      #         echo "All models copied into PVC."

      #     volumeMounts:
      #       - name: hf-cache
      #         mountPath: /models-cache

      #     resources:
      #       requests:
      #         cpu: "500m"
      #         memory: "3Gi"
      #       limits:
      #         cpu: "1"
      #         memory: "4Gi"

      # ----------------------------
      # MAIN CONTAINER
      # ----------------------------
      containers:
        - name: backend
          image: raginimetlapalli/social-media-engagement-backend:latest
          imagePullPolicy: Always

          ports:
            - containerPort: 8000

          env:
            - name: HF_HOME
              value: "/models"
            - name: TRANSFORMERS_CACHE
              value: "/models"
            - name: HF_CACHE
              value: "/models"
            - name: TORCH_HOME
              value: "/models/checkpoints"

            - name: STORJ_ACCESS_GRANT
              valueFrom:
                secretKeyRef:
                  name: storj-secret
                  key: ACCESS_GRANT

            - name: STORJ_BUCKET
              valueFrom:
                secretKeyRef:
                  name: storj-secret
                  key: BUCKET 

          volumeMounts:
            - name: hf-cache
              mountPath: "/models"

          # readinessProbe:
          #   httpGet:
          #     path: /
          #     port: 8000
          #   initialDelaySeconds: 30
          #   periodSeconds: 10

          # livenessProbe:
          #   httpGet:
          #     path: /
          #     port: 8000
          #   initialDelaySeconds: 60
          #   periodSeconds: 20

          # startupProbe:
          #   httpGet:
          #     path: /
          #     port: 8000
          #   failureThreshold: 60
          #   periodSeconds: 10
          #   # Gives 600 seconds = 10 min to fully start

          readinessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 20
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 120
            periodSeconds: 20


          resources:
            requests:
              cpu: "100m"
              memory: "1Gi"
            limits:
              cpu: "1000m"
              memory: "4Gi"

      # ----------------------------
      # VOLUMES
      # ----------------------------
      volumes:
        - name: hf-cache
          persistentVolumeClaim:
            claimName: hf-models-pvc

